# !/usr/bin/env python
import datetime
import inspect
from task import models
import public
import task


@public.add
class Task:
    """base class for a Task model. attrs: `name`, `category`, `description`, `disabled`. methods: `complete()`, `update()`. properties: `completed_at`. not implemented: `todo()`, ..."""
    name = None
    category = None
    description = None
    disabled = False

    def __init__(self, **kwargs):
        self.started_at = datetime.datetime.now()
        for k, v in kwargs.items():
            setattr(self, k, v)

    @property
    def module_name(self):
        return self.__class__.__module__

    @property
    def class_name(self):
        return self.__class__.__name__

    @property
    def slug(self):
        return self.__class__.__name__.replace("_","-").lower()

    def todo(self):
        path = "%s.%s" % (self.module_name, self.class_name)
        raise NotImplementedError('%s.todo() is not implemented' % path)

    def getobject(self):
        """return Task model object for this class"""
        kwargs = dict(
            name=self.name,
            module_name=self.module_name,
            class_name=self.class_name
        )
        try:
            return models.Task.objects.get(**kwargs)
        except models.Task.DoesNotExist:
            pass

    def create(self):
        """create model record and return object"""
        kwargs = dict(
            name=self.name,
            module_name=self.module_name,
            class_name=self.class_name
        )
        record, created = models.Task.objects.get_or_create(**kwargs)
        return record

    def update(self):
        """update record fields: `name`, `category`, `disabled`, `todo`, `updated_at`"""
        record = self.create()
        todo = self.todo
        record.todo = bool(todo()) if todo and inspect.isroutine(todo) else bool(todo)
        record.name = self.name
        record.slug = self.slug
        record.disabled = self.disabled
        record.category = self.category
        record.updated_at = datetime.datetime.now()
        record.save()

    @property
    def completed_at(self):
        task = self.getobject()
        if task:
            return task.completed_at

    def complete(self):
        task = self.getobject()
        now = datetime.datetime.now()
        if not hasattr(self, "started_at"):
            task.started_at = now
        task.updated_at = now
        task.completed_at = now
        task.todo = False
        task.save()

    @property
    def elapsed(self):
        task = self.getobject()
        if task:
            return task.elapsed

    def __str__(self):
        return '<Task name="%s">' % (self.name)


@public.add
def scan():
    """scan site-packages and sync Task classes"""
    task_classes = []
    for module in task.getmodules():
        for k, v in module.__dict__.items():
            if inspect.isclass(v) and issubclass(v, Task):
                task_classes.append(v)
    ids = []
    for cls in task_classes:
        row = cls().create()
        ids.append(row.id)
    models.Task.objects.exclude(class_name__isnull=True).exclude(id__in=ids).delete()

@public.add
def update():
    """update all tasks"""
    for task in models.Task.objects.exclude(class_name__isnull=True).all():
        cls = task.getclass()
        cls().update()
