# !/usr/bin/env python
# -*- coding: utf-8 -*-
import datetime
from django.db import models
from django_class.models import AbsClass
from django.utils.translation import gettext_lazy as _
import public


@public.add
class Category(AbsClass):
    """fields: `name`, `disabled`, `parent` (optional). methods: `getclass()`"""

    class Meta:
        app_label = 'task'
        db_table = 'category'

    name = models.CharField(_('Name'), max_length=100, null=True, blank=True)
    disabled = models.BooleanField(_('Disabled'), default=False)
    parent = models.ForeignKey('self', blank=True, null=True, on_delete=models.CASCADE)

    @property
    def tasks(self):
        return self.task_set.all()


@public.add
class Task(AbsClass):
    """fields: `module_name`, `class_name`, `name`, `slug`, `todo`, `disabled`, `completed_at`, `reminded_at`, `category` (optional). methods: `getclass()`. properties: `elapsed`"""

    class Meta:
        app_label = 'task'
        db_table = 'task'
        ordering = ['-created_at', 'name']

    slug = models.CharField(_('Slug'), max_length=100, null=True, blank=True)
    name = models.CharField(_('Name'), max_length=100)
    disabled = models.BooleanField(_('Disabled'), default=False)
    todo = models.BooleanField(_('TODO'), null=True, blank=True, default=False)
    category = models.ForeignKey(Category, on_delete=models.CASCADE, null=True, blank=True, verbose_name=_('Category'))
    description = models.TextField(_('Description'), null=True, blank=True)

    created_at = models.DateTimeField(auto_now_add=True, editable=False)
    updated_at = models.DateTimeField(null=True, blank=True, editable=False)
    completed_at = models.DateTimeField(null=True, blank=True, editable=False)
    reminded_at = models.DateTimeField(null=True, blank=True, editable=False)

    @property
    def elapsed(self):
        if not self.completed_at:
            return
        td = datetime.datetime.now()-self.completed_at
        return int(td.total_seconds())


    def __str__(self):
        completed_at = None
        if self.completed_at:
            completed_at = self.completed_at.strftime("%Y-%m-%d %H:%M:%S")
        string = '<Task id={id} name="{name}" todo={todo} module_name="{module_name}" class_name="{class_name}">'
        return string.format(
            id=self.id,
            name=self.name,
            todo=self.todo,
            module_name=self.module_name,
            class_name=self.class_name,
            completed_at=completed_at
        )

    def __repr__(self):
        return self.__str__()
